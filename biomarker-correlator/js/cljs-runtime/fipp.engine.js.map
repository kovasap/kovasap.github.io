{"version":3,"sources":["fipp/engine.cljc"],"mappings":"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","names":["js/fipp","js/fipp.engine","js/fipp.engine.serialize-node","method-table__4747__auto__","cljs.core.atom","prefer-table__4748__auto__","method-cache__4749__auto__","cached-hierarchy__4750__auto__","hierarchy__4751__auto__","cljs.core.get","fexpr__83750","cljs.core/MultiFn","cljs.core.symbol","fipp.engine/serialize-node","cljs.core/first","fipp.engine/serialize","doc","cljs.core/seq?","cljs.core.mapcat","cljs.core/Keyword","cljs.core/vector?","cljs.core.ex_info","p__83768","vec__83773","seq__83774","cljs.core/seq","first__83775","cljs.core/next","_","text","cljs.core.apply","cljs.core/str","p__83780","vec__83781","seq__83782","first__83783","p__83788","vec__83790","cljs.core.nth","js/Error","p__83793","vec__83794","seq__83795","first__83796","children","p__83798","vec__83799","inline","terminate","or__4253__auto__","p__83804","vec__83805","seq__83806","first__83807","cljs.core.concat","p__83810","vec__83812","seq__83813","first__83814","args","vec__83816","seq__83817","first__83818","offset","cljs.core/cons","p__83823","vec__83824","seq__83825","first__83826","vec__83827","seq__83828","first__83829","fipp.engine/annotate-rights","rf","pos","cljs.core/volatile!","res","node","delta","G__83832","cljs.core/count","p","G__83833","G__83834","cljs.core.assoc","var_args","args__4870__auto__","len__4864__auto__","i__4865__auto__","argseq__4871__auto__","cljs.core/IndexedSeq","fipp.engine/update-right","seq83841","G__83842","G__83843","self__4851__auto__","deque","f","fipp.deque/conjr","cljs.core/pop","cljs.core/peek","p__83849","map__83850","cljs.core/--destructure-map","fipp.engine/annotate-begins","width","options","bufs","fipp.deque/empty","p__83852","map__83853","op","right","cljs.core/deref","buffers","cljs.core/empty?","cljs.core._EQ_","position*","buffer","cljs.core/vreset!","fipp.deque/create","buffers*","begin","nodes","fipp.deque/conjlr","cljs.core.reduce","fipp.engine.update_right","cljs.core/update-in","fipp.deque/concat","buffers**","fipp.deque/popl","res*","p__83864","map__83865","fipp.engine/format-nodes","fits","length","tab-stops","column","p__83870","map__83871","indent","format-text","G__83876","G__83877","cljs.core.repeat","G__83878","G__83879","G__83880","cljs.core.conj","x__4336__auto__","y__4337__auto__","fipp.engine/print-fns","map__83888","print-fn","cljs.core/*print-fn*","*print-fn*-orig-val__83889","*print-fn*-temp-val__83890","cljs.core/println","G__83896","fipp.engine/pprint-document","document","fipp.engine.pprint_document","map__83898","cljs.core.merge","print","println","cljs.core.eduction","cljs.core/run!"],"sourcesContent":["(ns fipp.engine\n  \"See: Oleg Kiselyov, Simon Peyton-Jones, and Amr Sabry\n  Lazy v. Yield: Incremental, Linear Pretty-printing\"\n  (:require [fipp.deque :as deque])\n  #?(:clj (:import (java.io Writer))))\n\n\n;;; Serialize document into a stream\n\n(defmulti serialize-node first)\n\n(defn serialize [doc]\n  (cond\n    (nil? doc) nil\n    (seq? doc) (mapcat serialize doc)\n    (string? doc) [{:op :text, :text doc}]\n    (keyword? doc) (serialize-node [doc])\n    (vector? doc) (serialize-node doc)\n    :else (throw (ex-info \"Unexpected class for doc node\" {:node doc}))))\n\n;; Primitives\n;; See doc/primitives.md for details.\n\n(defmethod serialize-node :text [[_ & text]]\n  [{:op :text, :text (apply str text)}])\n\n(defmethod serialize-node :pass [[_ & text]]\n  [{:op :pass, :text (apply str text)}])\n\n(defmethod serialize-node :escaped [[_ text]]\n  (assert (string? text))\n  [{:op :escaped, :text text}])\n\n(defmethod serialize-node :span [[_ & children]]\n  (serialize children))\n\n(defmethod serialize-node :line [[_ inline terminate]]\n  (let [inline (or inline \" \")\n        terminate (or terminate \"\")]\n    (assert (string? inline))\n    (assert (string? terminate))\n    [{:op :line, :inline inline, :terminate terminate}]))\n\n(defmethod serialize-node :break [& _]\n  [{:op :break}])\n\n(defmethod serialize-node :group [[_ & children]]\n  (concat [{:op :begin}] (serialize children) [{:op :end}]))\n\n(defmethod serialize-node :nest [[_ & args]]\n  (let [[offset & children] (if (number? (first args))\n                              args\n                              (cons 2 args))]\n    (concat [{:op :nest, :offset offset}]\n            (serialize children)\n            [{:op :outdent}])))\n\n(defmethod serialize-node :align [[_ & args]]\n  (let [[offset & children] (if (number? (first args))\n                             args\n                             (cons 0 args))]\n    (concat [{:op :align, :offset offset}]\n            (serialize children)\n            [{:op :outdent}])))\n\n\n\n(defn annotate-rights\n  \"A transducer which annotates the right-side of nodes assuming a\n  hypothetical single-line formatting of the document. Groups and indentation\n  directives are temporarily assumed to be zero-width. These values are used\n  by subsequent passes to produce the final layout.\"\n  [rf]\n  (let [pos (volatile! 0)]\n    (fn\n      ([] (rf))\n      ([res] (rf res))\n      ([res node]\n       (let [delta (case (:op node)\n                     :text (count (:text node))\n                     :line (count (:inline node))\n                     :escaped 1\n                     0)\n             p (vswap! pos + delta)]\n         (rf res (assoc node :right p)))))))\n\n\n\n(defn update-right [deque f & args]\n  (deque/conjr (pop deque) (apply f (peek deque) args)))\n\n(defn annotate-begins\n  \"Given printing options, returns a transducer which annotate the right-side\n  of groups on their :begin nodes.  This includes the pruning algorithm which\n  will annotate some :begin nodes as being :too-far to the right without\n  calculating their exact sizes.\"\n  [{:keys [width] :as options}]\n  (fn [rf]\n    (let [pos (volatile! 0)\n          bufs (volatile! deque/empty)]\n      (fn\n        ([] (rf))\n        ([res] (rf res))\n        ([res {:keys [op right] :as node}]\n         (let [buffers @bufs]\n           (if (empty? buffers)\n             (if (= op :begin)\n               ;; Buffer groups\n               (let [position* (+ right width)\n                     buffer {:position position* :nodes deque/empty}]\n                 (vreset! pos position*)\n                 (vreset! bufs (deque/create buffer))\n                 res)\n               ;; Emit unbuffered\n               (rf res node))\n             (if (= op :end)\n               ;; Pop buffer\n               (let [buffer (peek buffers)\n                     buffers* (pop buffers)\n                     begin {:op :begin :right right}\n                     nodes (deque/conjlr begin (:nodes buffer) node)]\n                 (if (empty? buffers*)\n                   (do\n                     (vreset! pos 0)\n                     (vreset! bufs deque/empty)\n                     (reduce rf res nodes))\n                   (do\n                     (assert (vector? buffers*))\n                     (assert (vector? nodes))\n                     (vreset! bufs (update-right buffers* update-in [:nodes]\n                                                 deque/concat nodes))\n                     res)))\n               ;; Pruning lookahead\n               (loop [buffers* (if (= op :begin)\n                                 (deque/conjr buffers\n                                              {:position (+ right width)\n                                               :nodes deque/empty})\n                                 (update-right buffers update-in [:nodes]\n                                               deque/conjr node))\n                      res res]\n                 (if (and (<= right @pos) (<= (count buffers*) width))\n                   ;; Not too far\n                   (do (vreset! bufs buffers*)\n                       res)\n                   ;; Too far\n                   (let [buffer (first buffers*)\n                         buffers** (deque/popl buffers*)\n                         begin {:op :begin, :right :too-far}\n                         res* (rf res begin)\n                         res* (reduce rf res* (:nodes buffer))]\n                     (if (empty? buffers**)\n                       ;; Root buffered group\n                       (do\n                         (vreset! pos 0)\n                         (vreset! bufs deque/empty)\n                         res*)\n                       ;; Interior group\n                       (do\n                         (vreset! pos (:position (first buffers**)))\n                         (recur buffers** res*))))))\n            ))))))))\n\n\n(defn format-nodes\n  \"Given printing options, returns a transducer which produces the fully\n  laid-out strings.\"\n  [{:keys [width] :as options}]\n  (fn [rf]\n    (let [fits (volatile! 0)\n          length (volatile! width)\n          tab-stops (volatile! '(0)) ; Technically, an unbounded stack...\n          column (volatile! 0)]\n      (fn\n        ([] (rf))\n        ([res] (rf res))\n        ([res {:keys [op right] :as node}]\n         (let [indent (peek @tab-stops)\n               format-text (fn [text width]\n                             (let [res* (if (zero? @column)\n                                          (do (vswap! column + indent)\n                                              (rf res (apply str (repeat indent \\space))))\n                                          res)]\n                               (vswap! column + width)\n                               (rf res* text)))]\n           (case op\n             :text\n               (let [text (:text node)]\n                 (format-text text (count text)))\n\n             :escaped\n               (format-text (:text node) 1)\n\n             :pass\n               (format-text (:text node) 0)\n\n             :line\n               (if (zero? @fits)\n                 (do\n                   (vreset! length (- (+ right width) indent))\n                   (vreset! column 0)\n                   (rf res (str (:terminate node) \"\\n\")))\n                 (let [inline (:inline node)]\n                   (vswap! column + (count inline))\n                   (rf res inline)))\n             :break\n               (do\n                 (vreset! length (- (+ right width) indent))\n                 (vreset! column 0)\n                 (rf res \"\\n\"))\n             :nest\n               (do (vswap! tab-stops conj (+ indent (:offset node)))\n                   res)\n             :align\n               (do (vswap! tab-stops conj (+ @column (:offset node)))\n                   res)\n             :outdent\n               (do (vswap! tab-stops pop)\n                   res)\n             :begin\n               (do (vreset! fits (cond\n                                   (pos? @fits) (inc @fits)\n                                   (= right :too-far) 0\n                                   (<= right @length) 1\n                                   :else 0))\n                   res)\n             :end\n               (do (vreset! fits (max 0 (dec @fits)))\n                   res)\n             (throw (ex-info \"Unexpected node op\" {:node node}))))\n         )))))\n\n\n(defn print-fns\n  [options]\n  #?(:clj (let [{:keys [^Writer writer] :or {writer *out*}} options]\n            {:print #(.write writer ^String %)\n             :println (fn []\n                        (binding [*out* writer]\n                          (println)))})\n     :cljs (let [{:keys [print-fn] :or {print-fn *print-fn*}} options]\n             {:print print-fn\n              :println (fn []\n                         (binding [*print-fn* print-fn]\n                           (println)))})))\n\n\n(defn pprint-document\n  ([document]\n   (pprint-document document {}))\n  ([document options]\n   (let [options (merge {:width 70} options)\n         {:keys [print println]} (print-fns options)]\n     (->> (serialize document)\n          (eduction\n            annotate-rights\n            (annotate-begins options)\n            (format-nodes options))\n          (run! print))\n     (println))))\n\n\n(comment\n\n  (defn dbg [x]\n    (println \"DBG:\")\n    (clojure.pprint/pprint x)\n    (println \"----\")\n    x)\n\n  (serialize \"apple\")\n  (serialize [:text \"apple\" \"ball\"])\n  (serialize [:span \"apple\" [:group \"ball\" :line \"cat\"]])\n  (serialize [:span \"apple\" [:line \",\"] \"ball\"])\n\n  (def doc1 [:group \"A\" :line [:group \"B\" :line \"C\"]])\n  (def doc2 [:group \"A\" :line [:nest 2 \"B\" :line \"C\"] :line \"D\"])\n  (def doc3 [:group \"A\" :line\n             [:nest 2 \"B-XYZ\" [:align -3 :line \"C\"]] :line \"D\"])\n\n  (serialize doc1)\n\n  (let [options {:width 3}]\n    (->> doc3\n         serialize\n         (into [] (comp\n                    annotate-rights\n                    (annotate-begins options)\n                    (format-nodes options)\n                    ))\n         ;(run! print)\n         clojure.pprint/pprint\n         )\n    ;nil\n    )\n\n  ;; test of :pass op\n  (do\n    (pprint-document\n      [:group \"AB\" :line \"B\" :line \"C\"]\n      {:width 6}) \n    (println \"--\")\n    (pprint-document\n      [:group \"<AB>\" :line \"B\" :line \"C\"]\n      {:width 6}) \n    (println \"--\")\n    (pprint-document\n      [:group [:pass \"<\"] \"AB\" [:pass \">\"] :line \"B\" :line \"C\"]\n      {:width 6}))\n\n  (def ex1\n    [:group \"[\"\n        [:nest 2\n            [:line \"\"] \"0,\"\n            :line \"1,\"\n            :line \"2,\"\n            :line \"3\"\n            [:line \"\"]]\n        \"]\"])\n\n  (pprint-document ex1 {:width 20})\n  (pprint-document ex1 {:width 6})\n\n  (def ex2\n    [:span \"[\"\n        [:align\n            [:group [:line \"\"]] \"0,\"\n            [:group :line] \"1,\"\n            [:group :line] \"2,\"\n            [:group :line] \"3\"]\n        \"]\"])\n\n  (pprint-document ex2 {:width 20})\n  (pprint-document ex2 {:width 6})\n\n)\n"]}